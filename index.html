<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D 좌석 뷰 시뮬레이터</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overflow: hidden;
        }
        #canvas-container {
            width: 100%;
            height: 100%;
            position: fixed;
            top: 0;
            left: 0;
            z-index: -1;
            cursor: grab;
        }
        #canvas-container.grabbing {
            cursor: grabbing;
        }
        canvas {
            display: block;
        }
        .controls-panel {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 10;
            max-height: calc(100vh - 40px);
            overflow-y: auto;
        }
        #photo-modal {
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
        }
        #vr-canvas-container {
            width: 100%;
            height: 80vh;
            border-radius: 0.5rem;
            overflow: hidden;
        }
        /* 좌석 배치도 SVG 스타일 */
        .seating-map-svg path, .seating-map-svg polygon, .seating-map-svg rect {
            fill: #4b5563; /* gray-600 */
            stroke: #1f2937; /* gray-800 */
            stroke-width: 2;
            transition: fill 0.2s ease-in-out;
            cursor: pointer;
        }
        .seating-map-svg path:hover, .seating-map-svg polygon:hover, .seating-map-svg rect:hover {
            fill: #6b7280; /* gray-500 */
        }
        .seating-map-svg path.selected, .seating-map-svg polygon.selected, .seating-map-svg rect.selected {
            fill: #a855f7; /* purple-500 */
        }
        .seating-map-svg text {
            font-size: 14px;
            fill: white;
            text-anchor: middle;
            pointer-events: none;
        }
        /* 오른쪽 위 좌석 도면 스타일 */
        #seating-map-overview {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10;
            width: 200px;
        }
    </style>
</head>
<body class="bg-gray-900 text-white">

    <div id="canvas-container"></div>

    <!-- 컨트롤 패널 (왼쪽) -->
    <div class="controls-panel w-full max-w-sm md:max-w-xs">
        <div class="bg-gray-800/80 backdrop-blur-sm p-6 rounded-2xl shadow-lg">
            <h1 class="text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-600 mb-1">3D 좌석 뷰 시뮬레이터</h1>
            <p class="text-gray-400 text-sm mb-4">장소 이름을 검색하고 좌석을 선택해 보세요.</p>
            
            <div class="space-y-4">
                <div>
                    <label for="venue-search" class="block text-sm font-medium text-gray-300 mb-1">장소 검색</label>
                    <div class="flex space-x-2">
                        <input type="text" id="venue-search" value="롯데콘서트홀" placeholder="예: 롯데콘서트홀, 야구장 등" class="w-full bg-gray-700 border-gray-600 text-white rounded-lg p-2 focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                        <button id="map-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold p-2 rounded-lg transition" title="지도에서 위치 보기">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" /></svg>
                        </button>
                    </div>
                </div>
                <div>
                    <label for="section" class="block text-sm font-medium text-gray-300 mb-1">구역</label>
                    <select id="section" class="w-full bg-gray-700 border-gray-600 text-white rounded-lg p-2 focus:ring-2 focus:ring-purple-500 focus:border-purple-500"></select>
                </div>
                <div>
                    <label for="row" class="block text-sm font-medium text-gray-300 mb-1">열 (1-15)</label>
                    <input type="number" id="row" value="8" min="1" max="15" class="w-full bg-gray-700 border-gray-600 text-white rounded-lg p-2 focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                </div>
                <div>
                    <label for="seat" class="block text-sm font-medium text-gray-300 mb-1">좌석 번호 (1-20)</label>
                    <input type="number" id="seat" value="10" min="1" max="20" class="w-full bg-gray-700 border-gray-600 text-white rounded-lg p-2 focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                </div>
            </div>
             <div id="seat-info" class="mt-4 text-center text-gray-300 bg-gray-700/50 p-3 rounded-lg text-sm">좌석을 선택해주세요.</div>
            <button id="show-photo-btn" class="w-full mt-4 bg-gradient-to-r from-teal-400 to-blue-500 hover:from-teal-500 hover:to-blue-600 text-white font-bold py-3 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">360° 실사 뷰 보기</button>
        </div>
    </div>

    <!-- 좌석 도면 (오른쪽 위) -->
    <div id="seating-map-overview" class="bg-gray-800/80 backdrop-blur-sm p-2 rounded-lg border border-gray-700 shadow-lg"></div>

    <!-- 실사 뷰 모달 -->
    <div id="photo-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4">
        <div class="bg-gray-800 rounded-2xl shadow-2xl w-full max-w-4xl relative p-4 border border-gray-700">
            <button id="close-modal-btn" class="absolute -top-3 -right-3 bg-white text-gray-800 rounded-full w-8 h-8 flex items-center justify-center font-bold text-lg">&times;</button>
            <div id="vr-canvas-container"></div>
            <p id="photo-description" class="text-center text-gray-300 mt-2 font-semibold"></p>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        // --- UI 요소 ---
        const venueSearchInput = document.getElementById('venue-search');
        const mapBtn = document.getElementById('map-btn');
        const sectionSelect = document.getElementById('section');
        const rowInput = document.getElementById('row');
        const seatInput = document.getElementById('seat');
        const seatInfo = document.getElementById('seat-info');
        const canvasContainer = document.getElementById('canvas-container');
        const showPhotoBtn = document.getElementById('show-photo-btn');
        const photoModal = document.getElementById('photo-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const vrCanvasContainer = document.getElementById('vr-canvas-container');
        const photoDescription = document.getElementById('photo-description');
        const seatingMapOverviewContainer = document.getElementById('seating-map-overview');
        // BUG FIX: eventListContainer 변수 선언이 누락되어 추가했습니다.
        const eventListContainer = document.querySelector('[data-id="event-list-container"]');


        // --- Three.js 기본 설정 ---
        let scene, camera, renderer;
        let venueGroup = new THREE.Group();
        let targetPosition = new THREE.Vector3();
        let stageCenter = new THREE.Vector3(0, 10, 0);

        // --- 360 VR 뷰 변수 ---
        let vrScene, vrCamera, vrRenderer, vrAnimationId;

        // --- 상태 변수 ---
        let isDragging = false;
        let previousMousePosition = { x: 0, y: 0 };
        let currentVenueKey = 'lotteConcertHall';
        let euler = new THREE.Euler(0, 0, 0, 'YXZ');

        // --- SVG 좌석 배치도 데이터 ---
        const seatingMaps = {
            lotteConcertHall: `<svg viewBox="0 0 300 300" class="seating-map-svg"><rect data-section="c-block" x="100" y="180" width="100" height="60"></rect><path data-section="p-block" d="M100 245 H200 L220 280 H80 Z"></path><path data-section="l1-block" d="M40 170 L95 175 L90 260 L20 250 Z"></path><path data-section="r1-block" d="M260 170 L205 175 L210 260 L280 250 Z"></path><path data-section="l2-block" d="M20 165 L90 170 L80 80 L0 90 Z"></path><path data-section="r2-block" d="M280 165 L210 170 L220 80 L300 90 Z"></path><circle cx="150" cy="150" r="40" fill="#be185d" style="pointer-events: none;"></circle><text x="150" y="155" font-size="20">STAGE</text></svg>`,
            stadium: `<svg viewBox="0 0 300 300" class="seating-map-svg"><rect x="70" y="50" width="160" height="200" fill="#166534" /><text x="150" y="35">N</text><path data-section="n-stand" d="M80 0 H220 L200 40 H100 Z"></path><text x="150" y="285">S</text><path data-section="s-stand" d="M80 300 H220 L200 260 H100 Z"></path><text x="35" y="150" transform="rotate(-90 35,150)">W</text><path data-section="w-stand" d="M0 80 V220 L40 200 V100 Z"></path><text x="265" y="150" transform="rotate(90 265,150)">E</text><path data-section="e-stand" d="M300 80 V220 L260 200 V100 Z"></path></svg>`,
        };

        // --- 장소별 데이터 ---
        const venueData = {
            'lotteConcertHall': {
                name: '롯데콘서트홀',
                stageCenter: new THREE.Vector3(0, 5, 0),
                model: [
                    { type: 'cylinder', args: [25, 25, 2, 64], position: [0, 1, 0], color: 0xbe185d }, // Stage
                    { type: 'plane', args: [30, 20], position: [-40, 10, 0], rotation: [0, Math.PI/2, -0.2], color: 0x374151 }, // L1
                    { type: 'plane', args: [30, 20], position: [40, 10, 0], rotation: [0, -Math.PI/2, 0.2], color: 0x374151 }, // R1
                    { type: 'plane', args: [30, 20], position: [0, 10, -40], rotation: [0.2, 0, 0], color: 0x374151 }, // C
                    { type: 'plane', args: [30, 20], position: [0, 10, 40], rotation: [-0.2, 0, 0], color: 0x374151 }, // P
                    { type: 'plane', args: [30, 25], position: [-50, 25, 0], rotation: [0, Math.PI/2, -0.3], color: 0x4b5563 }, // L2
                    { type: 'plane', args: [30, 25], position: [50, 25, 0], rotation: [0, -Math.PI/2, 0.3], color: 0x4b5563 }, // R2
                ],
                sections: {
                    'c-block': { name: 'C블록', z: -40, y_base: 5, y_mult: 0.8, x_mult: 1.5, photo: '2048x1024/cccccc/000000?text=Sample+360+View' },
                    'p-block': { name: 'P블록', z: 40, y_base: 8, y_mult: 0.8, x_mult: 1.5, photo: '2048x1024/cccccc/000000?text=Sample+360+View' },
                    'l1-block': { name: 'L1블록', x: -40, y_base: 5, y_mult: 0.8, z_mult: 1, photo: '2048x1024/cccccc/000000?text=Sample+360+View' },
                    'r1-block': { name: 'R1블록', x: 40, y_base: 5, y_mult: 0.8, z_mult: 1, photo: '2048x1024/cccccc/000000?text=Sample+360+View' },
                    'l2-block': { name: 'L2블록', x: -50, y_base: 20, y_mult: 0.8, z_mult: 1, photo: '2048x1024/cccccc/000000?text=Sample+360+View' },
                    'r2-block': { name: 'R2블록', x: 50, y_base: 20, y_mult: 0.8, z_mult: 1, photo: '2048x1024/cccccc/000000?text=Sample+360+View' },
                },
                events: [
                    { date: '2025-11-20', title: '피아니스트 조성진 리사이틀', type: '클래식' },
                    { date: '2025-12-25', title: '크리스마스 재즈 콘서트', type: '콘서트' }
                ]
            },
            'stadium': {
                name: '종합 경기장',
                stageCenter: new THREE.Vector3(0, 10, 0),
                model: [
                    { type: 'box', args: [80, 2, 40], position: [0, 1, 0], color: 0x5b21b6 },
                    { type: 'plane', args: [120, 40], position: [-80, 20, 0], rotation: [0, Math.PI/2, -0.4], color: 0x374151 }, // W
                    { type: 'plane', args: [120, 40], position: [80, 20, 0], rotation: [0, -Math.PI/2, 0.4], color: 0x374151 }, // E
                    { type: 'plane', args: [120, 40], position: [0, 20, -80], rotation: [0.4, 0, 0], color: 0x374151 }, // N
                    { type: 'plane', args: [120, 40], position: [0, 20, 80], rotation: [-0.4, 0, 0], color: 0x374151 }, // S
                ],
                sections: {
                    'w-stand': { name: 'W 스탠드', x: -75, y_base: 5, y_mult: 1, z_mult: 2.5, photo: '2048x1024/cccccc/000000?text=Sample+360+View' },
                    'e-stand': { name: 'E 스탠드', x: 75, y_base: 5, y_mult: 1, z_mult: 2.5, photo: '2048x1024/cccccc/000000?text=Sample+360+View' },
                    'n-stand': { name: 'N 스탠드', z: -75, y_base: 5, y_mult: 1, x_mult: 2.5, photo: '2048x1024/cccccc/000000?text=Sample+360+View' },
                    's-stand': { name: 'S 스탠드', z: 75, y_base: 5, y_mult: 1, x_mult: 2.5, photo: '2048x1024/cccccc/000000?text=Sample+360+View' },
                },
                events: [
                    { date: '2025-09-15', title: '국가대표 평가전: 대한민국 vs 브라질', type: '스포츠' },
                    { date: '2025-10-02', title: '글로벌 K-POP 페스티벌', type: '콘서트' }
                ]
            }
        };

        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x111827);
            scene.add(venueGroup);
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 50, 150);
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            canvasContainer.appendChild(renderer.domElement);
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.8);
            scene.add(ambientLight);
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.5);
            directionalLight.position.set(0, 100, 50);
            scene.add(directionalLight);
            const floor = new THREE.Mesh(new THREE.PlaneGeometry(500, 500), new THREE.MeshLambertMaterial({ color: 0x1f2937 }));
            floor.rotation.x = -Math.PI / 2;
            scene.add(floor);

            venueSearchInput.addEventListener('keyup', (e) => { if (e.key === 'Enter') handleSearch(); });
            mapBtn.addEventListener('click', openMap);
            sectionSelect.addEventListener('change', handleSeatChange);
            rowInput.addEventListener('input', handleSeatChange);
            seatInput.addEventListener('input', handleSeatChange);
            window.addEventListener('resize', onWindowResize);
            canvasContainer.addEventListener('mousedown', onMouseDown);
            canvasContainer.addEventListener('mousemove', onMouseMove);
            canvasContainer.addEventListener('mouseup', onMouseUp);
            canvasContainer.addEventListener('mouseleave', onMouseUp);
            showPhotoBtn.addEventListener('click', showVRModal);
            closeModalBtn.addEventListener('click', hideVRModal);
            photoModal.addEventListener('click', (e) => { if(e.target === photoModal) hideVRModal(); });
            
            document.addEventListener('click', (e) => {
                const path = e.target.closest('.seating-map-svg path, .seating-map-svg polygon, .seating-map-svg rect');
                if (path && path.dataset.section) {
                    sectionSelect.value = path.dataset.section;
                    handleSeatChange();
                }
            });

            handleSearch(); 
            animate();
        }
        
        function handleSearch() {
            const query = venueSearchInput.value.toLowerCase();
            if (query.includes('롯데') || query.includes('콘서트')) {
                currentVenueKey = 'lotteConcertHall';
            } else {
                currentVenueKey = 'stadium';
            }
            buildScene();
        }

        function openMap() {
            const query = venueSearchInput.value;
            if (query) {
                const url = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(query)}`;
                window.open(url, '_blank');
            }
        }

        function buildScene() {
            while(venueGroup.children.length > 0){ venueGroup.remove(venueGroup.children[0]); }
            const data = venueData[currentVenueKey];
            stageCenter = data.stageCenter;
            data.model.forEach(objInfo => {
                let geometry, material, mesh;
                material = new THREE.MeshLambertMaterial({ color: objInfo.color, side: THREE.DoubleSide });
                if (objInfo.type === 'box') geometry = new THREE.BoxGeometry(...objInfo.args);
                if (objInfo.type === 'cylinder') geometry = new THREE.CylinderGeometry(...objInfo.args);
                if (objInfo.type === 'plane') geometry = new THREE.PlaneGeometry(...objInfo.args);
                mesh = new THREE.Mesh(geometry, material);
                mesh.position.set(...objInfo.position);
                if(objInfo.rotation) mesh.rotation.set(...objInfo.rotation);
                venueGroup.add(mesh);
            });
            sectionSelect.innerHTML = '';
            for (const key in data.sections) {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = data.sections[key].name;
                sectionSelect.appendChild(option);
            }
            seatingMapOverviewContainer.innerHTML = seatingMaps[currentVenueKey];
            updateEventList();
            handleSeatChange();
        }

        function updateEventList() {
            if (!eventListContainer) return; // defensive check
            eventListContainer.innerHTML = '';
            const data = venueData[currentVenueKey];
            if (data.events && data.events.length > 0) {
                data.events.forEach(event => {
                    const eventDiv = document.createElement('div');
                    eventDiv.className = 'bg-gray-700/50 p-3 rounded-lg';
                    const typeColor = event.type === '스포츠' ? 'text-green-400' : 'text-pink-400';
                    eventDiv.innerHTML = `
                        <p class="font-semibold text-white text-sm">${event.title}</p>
                        <div class="flex justify-between items-center mt-1">
                            <span class="text-xs text-gray-400">${event.date}</span>
                            <span class="text-xs font-bold ${typeColor}">${event.type}</span>
                        </div>
                    `;
                    eventListContainer.appendChild(eventDiv);
                });
            } else {
                eventListContainer.innerHTML = `<p class="text-sm text-gray-400 text-center">예정된 행사가 없습니다.</p>`;
            }
        }

        function handleSeatChange() {
            const sectionKey = sectionSelect.value;
            const data = venueData[currentVenueKey].sections[sectionKey];
            if (!data) return;
            const row = Math.max(1, Math.min(30, parseInt(rowInput.value) || 15));
            const seat = Math.max(1, Math.min(50, parseInt(seatInput.value) || 25));
            rowInput.value = row;
            seatInput.value = seat;
            const seatCenterOffset = seat - 25.5;

            let x, y, z;
            x = data.x || 0;
            z = data.z || 0;
            if (data.x_mult) x += seatCenterOffset * data.x_mult;
            if (data.z_mult) z += seatCenterOffset * data.z_mult;
            y = data.y_base + (row * data.y_mult);

            targetPosition.set(x, y, z);
            
            const tempMatrix = new THREE.Matrix4();
            tempMatrix.lookAt(targetPosition, stageCenter, camera.up);
            euler.setFromRotationMatrix(tempMatrix);
            camera.quaternion.setFromEuler(euler);

            seatInfo.textContent = `${venueData[currentVenueKey].name} / ${data.name} / ${row}열 / ${seat}번`;
            updateMapSelection();
        }

        function updateMapSelection() {
            const selectedSection = sectionSelect.value;
            document.querySelectorAll('.seating-map-svg path, .seating-map-svg polygon, .seating-map-svg rect').forEach(p => {
                p.classList.remove('selected');
                if (p.dataset.section === selectedSection) {
                    p.classList.add('selected');
                }
            });
        }

        function showVRModal() {
            const sectionKey = sectionSelect.value;
            const section = venueData[currentVenueKey].sections[sectionKey];
            if (section && section.photo) {
                photoDescription.textContent = `${section.name} 구역 360° 뷰 (샘플 이미지)`;
                photoModal.classList.remove('hidden');
                initVR(`https://placehold.co/${section.photo}`);
            }
        }
        
        function hideVRModal() {
            photoModal.classList.add('hidden');
            if (vrAnimationId) {
                cancelAnimationFrame(vrAnimationId);
            }
            if (vrRenderer) {
                vrRenderer.dispose();
                vrCanvasContainer.innerHTML = '';
            }
        }

        function initVR(imageUrl) {
            vrScene = new THREE.Scene();
            vrCamera = new THREE.PerspectiveCamera(75, vrCanvasContainer.clientWidth / vrCanvasContainer.clientHeight, 1, 1100);
            vrRenderer = new THREE.WebGLRenderer({ antialias: true });
            vrRenderer.setSize(vrCanvasContainer.clientWidth, vrCanvasContainer.clientHeight);
            vrCanvasContainer.appendChild(vrRenderer.domElement);

            const geometry = new THREE.SphereGeometry(500, 60, 40);
            geometry.scale(-1, 1, 1); // Sphere 안쪽 면을 보도록 뒤집기

            const texture = new THREE.TextureLoader().load(imageUrl);
            const material = new THREE.MeshBasicMaterial({ map: texture });
            const sphere = new THREE.Mesh(geometry, material);
            vrScene.add(sphere);

            let isVrDragging = false;
            let previousVrMousePosition = { x: 0, y: 0 };
            let vrEuler = new THREE.Euler(0, 0, 0, 'YXZ');

            function onVrPointerDown(e) {
                isVrDragging = true;
                const pointer = e.touches ? e.touches[0] : e;
                previousVrMousePosition = { x: pointer.clientX, y: pointer.clientY };
            }
            function onVrPointerUp() {
                isVrDragging = false;
            }
            function onVrPointerMove(e) {
                if (!isVrDragging) return;
                const pointer = e.touches ? e.touches[0] : e;
                const deltaX = pointer.clientX - previousVrMousePosition.x;
                const deltaY = pointer.clientY - previousVrMousePosition.y;

                vrEuler.y -= deltaX * 0.004;
                vrEuler.x -= deltaY * 0.004;
                vrEuler.x = Math.max(-Math.PI / 2, Math.min(Math.PI / 2, vrEuler.x));
                vrCamera.quaternion.setFromEuler(vrEuler);

                previousVrMousePosition = { x: pointer.clientX, y: pointer.clientY };
            }

            vrCanvasContainer.addEventListener('mousedown', onVrPointerDown);
            vrCanvasContainer.addEventListener('mousemove', onVrPointerMove);
            vrCanvasContainer.addEventListener('mouseup', onVrPointerUp);
            vrCanvasContainer.addEventListener('mouseleave', onVrPointerUp);
            vrCanvasContainer.addEventListener('touchstart', onVrPointerDown);
            vrCanvasContainer.addEventListener('touchmove', onVrPointerMove);
            vrCanvasContainer.addEventListener('touchend', onVrPointerUp);

            function animateVR() {
                vrAnimationId = requestAnimationFrame(animateVR);
                vrRenderer.render(vrScene, vrCamera);
            }
            animateVR();
        }

        function onMouseDown(e) { isDragging = true; canvasContainer.classList.add('grabbing'); previousMousePosition.x = e.clientX; previousMousePosition.y = e.clientY; }
        function onMouseUp() { isDragging = false; canvasContainer.classList.remove('grabbing'); }
        function onMouseMove(e) {
            if (!isDragging) return;
            const deltaX = e.clientX - previousMousePosition.x;
            const deltaY = e.clientY - previousMousePosition.y;
            
            euler.y -= deltaX * 0.002;
            euler.x -= deltaY * 0.002;
            euler.x = Math.max(-Math.PI / 2, Math.min(Math.PI / 2, euler.x));

            previousMousePosition.x = e.clientX;
            previousMousePosition.y = e.clientY;
        }

        function animate() {
            requestAnimationFrame(animate);
            if (camera.position.distanceTo(targetPosition) > 0.01) {
                camera.position.lerp(targetPosition, 0.1);
            }
            camera.quaternion.setFromEuler(euler);
            renderer.render(scene, camera);
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        init();
    </script>
</body>
</html>
