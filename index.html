<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D 좌석 뷰 시뮬레이터</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overflow: hidden;
        }
        #canvas-container {
            width: 100%;
            height: 100%;
            position: fixed;
            top: 0;
            left: 0;
            z-index: -1;
            cursor: grab;
        }
        #canvas-container.grabbing {
            cursor: grabbing;
        }
        canvas {
            display: block;
        }
        .controls-panel {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 10;
            max-height: calc(100vh - 40px);
            overflow-y: auto;
        }
        #photo-modal {
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
        }
        #vr-canvas-container {
            width: 100%;
            height: 80vh;
            border-radius: 0.5rem;
            overflow: hidden;
        }
        /* 좌석 배치도 SVG 스타일 */
        .seating-map-svg path, .seating-map-svg polygon, .seating-map-svg rect {
            fill: #4b5563; /* gray-600 */
            stroke: #1f2937; /* gray-800 */
            stroke-width: 2;
            transition: fill 0.2s ease-in-out;
            cursor: pointer;
        }
        .seating-map-svg path:hover, .seating-map-svg polygon:hover, .seating-map-svg rect:hover {
            fill: #6b7280; /* gray-500 */
        }
        .seating-map-svg path.selected, .seating-map-svg polygon.selected, .seating-map-svg rect.selected {
            fill: #a855f7; /* purple-500 */
        }
        .seating-map-svg text {
            font-size: 14px;
            fill: white;
            text-anchor: middle;
            pointer-events: none;
        }
        /* 오른쪽 위 좌석 도면 스타일 */
        #seating-map-overview {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10;
            width: 200px;
        }
        #overview-marker {
            fill: #ec4899;
            stroke: white;
            stroke-width: 2px;
            transition: all 0.3s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-900 text-white">

    <div id="canvas-container"></div>

    <!-- 컨트롤 패널 (왼쪽) -->
    <div class="controls-panel w-full max-w-sm">
        <div class="bg-gray-800/80 backdrop-blur-sm p-6 rounded-2xl shadow-lg">
            <h1 class="text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-600 mb-1">3D 좌석 뷰 시뮬레이터</h1>
            <p class="text-gray-400 text-sm mb-4">장소를 검색하고 좌석을 선택해 보세요.</p>
            
            <div class="space-y-4">
                 <div>
                    <label for="venue-search" class="block text-sm font-medium text-gray-300 mb-1">장소 검색</label>
                    <div class="flex space-x-2">
                        <input type="text" id="venue-search" value="잠실 야구장" placeholder="예: 야구장, 농구장, 체육관 등" class="w-full bg-gray-700 border-gray-600 text-white rounded-lg p-2 focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                         <button id="map-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold p-2 rounded-lg transition" title="지도에서 위치 보기">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" /></svg>
                        </button>
                    </div>
                </div>
                <div>
                    <label for="section" class="block text-sm font-medium text-gray-300 mb-1">구역</label>
                    <select id="section" class="w-full bg-gray-700 border-gray-600 text-white rounded-lg p-2 focus:ring-2 focus:ring-purple-500 focus:border-purple-500"></select>
                </div>
                <div>
                    <label for="row" class="block text-sm font-medium text-gray-300 mb-1">열</label>
                    <input type="number" id="row" value="15" class="w-full bg-gray-700 border-gray-600 text-white rounded-lg p-2" >
                </div>
                <div>
                    <label for="seat" class="block text-sm font-medium text-gray-300 mb-1">좌석</label>
                    <input type="number" id="seat" value="10" class="w-full bg-gray-700 border-gray-600 text-white rounded-lg p-2" >
                </div>
            </div>

             <div id="seat-info" class="mt-4 text-center text-gray-300 bg-gray-700/50 p-3 rounded-lg text-sm">좌석을 선택해주세요.</div>
            <button id="show-photo-btn" class="w-full mt-4 bg-gradient-to-r from-teal-400 to-blue-500 hover:from-teal-500 hover:to-blue-600 text-white font-bold py-3 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">360° 실사 뷰 보기</button>
            
            <!-- 행사 목록 섹션 -->
            <div id="event-list-container" class="mt-6 pt-4 border-t border-gray-700">
                <!-- 이벤트 목록이 동적으로 추가됩니다. -->
            </div>
        </div>
    </div>

    <!-- 좌석 도면 (오른쪽 위) -->
    <div id="seating-map-overview" class="bg-gray-800/80 backdrop-blur-sm p-2 rounded-lg border border-gray-700 shadow-lg"></div>

    <!-- 실사 뷰 모달 -->
    <div id="photo-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4">
        <div class="bg-gray-800 rounded-2xl shadow-2xl w-full max-w-4xl relative p-4 border border-gray-700">
            <button id="close-modal-btn" class="absolute -top-3 -right-3 bg-white text-gray-800 rounded-full w-8 h-8 flex items-center justify-center font-bold text-lg">&times;</button>
            <div id="vr-canvas-container"></div>
            <p id="photo-description" class="text-center text-gray-300 mt-2 font-semibold"></p>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        // --- UI 요소 ---
        const venueSearchInput = document.getElementById('venue-search');
        const mapBtn = document.getElementById('map-btn');
        const sectionSelect = document.getElementById('section');
        const rowInput = document.getElementById('row');
        const seatInput = document.getElementById('seat');
        const seatInfo = document.getElementById('seat-info');
        const canvasContainer = document.getElementById('canvas-container');
        const showPhotoBtn = document.getElementById('show-photo-btn');
        const photoModal = document.getElementById('photo-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const vrCanvasContainer = document.getElementById('vr-canvas-container');
        const photoDescription = document.getElementById('photo-description');
        const seatingMapOverviewContainer = document.getElementById('seating-map-overview');
        const eventListContainer = document.getElementById('event-list-container');

        // --- Three.js 기본 설정 ---
        let scene, camera, renderer, raycaster;
        let venueGroup = new THREE.Group();
        let seatsGroup = new THREE.Group();
        let targetPosition = new THREE.Vector3();
        let stageCenter = new THREE.Vector3(0, 5, 0);

        // --- 360 VR 뷰 변수 ---
        let vrScene, vrCamera, vrRenderer, vrAnimationId;

        // --- 상태 변수 ---
        let isDragging = false;
        let previousMousePosition = { x: 0, y: 0 };
        let euler = new THREE.Euler(0, 0, 0, 'YXZ');
        let selectedSeatObject3D = null;
        let currentVenueKey = 'theater';
        const mouse = new THREE.Vector2();

        // --- 재질 ---
        const seatMaterial = new THREE.MeshLambertMaterial({ color: 0x6b7280 });
        const selectedSeatMaterial = new THREE.MeshLambertMaterial({ color: 0xec4899 });

        // --- SVG 좌석 배치도 데이터 ---
        const seatingMaps = {
            stadium: `<svg viewBox="0 0 300 300" class="seating-map-svg"><rect x="70" y="50" width="160" height="200" fill="#166534" style="pointer-events:none;"/><rect x="60" y="40" width="180" height="220" fill="none" stroke="#eab308" stroke-width="5" rx="20" style="pointer-events:none;"/><text x="150" y="35">N</text><path data-section="n-stand" d="M80 0 H220 L200 40 H100 Z"></path><text x="150" y="285">S</text><path data-section="s-stand" d="M80 300 H220 L200 260 H100 Z"></path><text x="35" y="150" transform="rotate(-90 35,150)">W</text><path data-section="w-stand" d="M0 80 V220 L40 200 V100 Z"></path><text x="265" y="150" transform="rotate(90 265,150)">E</text><path data-section="e-stand" d="M300 80 V220 L260 200 V100 Z"></path><circle id="overview-marker" r="8" cx="-20" cy="-20" fill="#ec4899" stroke="white" stroke-width="2px"></circle></svg>`,
            concertHall: `<svg viewBox="0 0 300 250" class="seating-map-svg"><path data-section="floor" d="M75 160 H225 V220 H75 Z"></path><path data-section="box-l" d="M25 100 H70 V220 H25 Z"></path><path data-section="box-r" d="M230 100 H275 V220 H230 Z"></path><text x="150" y="50" font-size="20">STAGE</text><circle id="overview-marker" r="8" cx="-20" cy="-20" fill="#ec4899" stroke="white" stroke-width="2px"></circle></svg>`,
            theater: `<svg viewBox="0 0 300 250" class="seating-map-svg"><path data-section="level1" d="M50 150 Q150 220 250 150 L260 200 Q150 270 40 200 Z"></path><path data-section="level2" d="M40 100 Q150 160 260 100 L270 140 Q150 200 30 140 Z"></path><path data-section="level3" d="M30 50 Q150 100 270 50 L280 80 Q150 130 20 80 Z"></path><text x="150" y="30" font-size="20">STAGE</text><circle id="overview-marker" r="8" cx="-20" cy="-20" fill="#ec4899" stroke="white" stroke-width="2px"></circle></svg>`,
            baseball: `<svg viewBox="0 0 300 300" class="seating-map-svg"><path d="M150 150 L 250 50 L 250 150 Z" fill="#92400e" style="pointer-events:none;"/><path d="M150 150 L 50 50 L 50 150 Z" fill="#92400e" style="pointer-events:none;"/><polygon data-section="infield-1b" points="150,150 250,150 250,50"></polygon><polygon data-section="infield-3b" points="150,150 50,150 50,50"></polygon><path data-section="outfield" d="M50 50 C 50 -50, 250 -50, 250 50"></path><polygon data-section="premium" points="150,150 180,180 120,180"></polygon><text x="150" y="220" font-size="16">HOME</text><circle id="overview-marker" r="8" cx="-20" cy="-20" fill="#ec4899" stroke="white" stroke-width="2px"></circle></svg>`,
            basketball: `<svg viewBox="0 0 300 200" class="seating-map-svg"><rect x="100" y="50" width="100" height="100" fill="#d97706" style="pointer-events: none;" /><circle cx="150" cy="100" r="15" stroke="white" stroke-width="1" fill="none" style="pointer-events:none;"/><path d="M 100 65 A 30 30 0 0 0 100 135" stroke="white" stroke-width="1" fill="none" style="pointer-events:none;"/><path d="M 200 65 A 30 30 0 0 1 200 135" stroke="white" stroke-width="1" fill="none" style="pointer-events:none;"/><rect data-section="courtside" x="90" y="155" width="120" height="10"></rect><rect data-section="lower-w" x="80" y="40" width="15" height="120"></rect><rect data-section="lower-e" x="205" y="40" width="15" height="120"></rect><rect data-section="upper-w" x="60" y="20" width="15" height="160"></rect><rect data-section="upper-e" x="225" y="20" width="15" height="160"></rect><circle id="overview-marker" r="8" cx="-20" cy="-20" fill="#ec4899" stroke="white" stroke-width="2px"></circle></svg>`,
            gymnasium: `<svg viewBox="0 0 300 200" class="seating-map-svg"><rect x="100" y="50" width="100" height="100" fill="#065f46" style="pointer-events: none;" /><line x1="100" y1="100" x2="200" y2="100" stroke="white" stroke-width="1" style="pointer-events:none;"/><circle cx="150" cy="100" r="15" stroke="white" stroke-width="1" fill="none" style="pointer-events:none;"/><rect data-section="floor" x="90" y="155" width="120" height="10"></rect><rect data-section="stand-w" x="40" y="40" width="50" height="120"></rect><rect data-section="stand-e" x="210" y="40" width="50" height="120"></rect><circle id="overview-marker" r="8" cx="-20" cy="-20" fill="#ec4899" stroke="white" stroke-width="2px"></circle></svg>`
        };

        // --- 장소별 데이터 ---
        const venueData = {
            'stadium': {
                name: '종합 경기장',
                stageCenter: new THREE.Vector3(0, 10, 0),
                model: [
                    { type: 'box', args: [80, 2, 40], position: [0, 1, 0], color: 0x5b21b6 },
                    { type: 'plane', args: [120, 40], position: [-80, 20, 0], rotation: [0, Math.PI/2, -0.4], color: 0x374151 }, // W
                    { type: 'plane', args: [120, 40], position: [80, 20, 0], rotation: [0, -Math.PI/2, 0.4], color: 0x374151 }, // E
                    { type: 'plane', args: [120, 40], position: [0, 20, -80], rotation: [0.4, 0, 0], color: 0x374151 }, // N
                    { type: 'plane', args: [120, 40], position: [0, 20, 80], rotation: [-0.4, 0, 0], color: 0x374151 }, // S
                ],
                sections: {
                    'w-stand': { name: 'W 스탠드', x: -75, y_base: 5, y_mult: 1, z_start: -50, z_mult: 2, photo: '600x400/1a202c/ffffff?text=W+Stand+View' },
                    'e-stand': { name: 'E 스탠드', x: 75, y_base: 5, y_mult: 1, z_start: -50, z_mult: 2, photo: '600x400/1a202c/ffffff?text=E+Stand+View' },
                    'n-stand': { name: 'N 스탠드', z: -75, y_base: 5, y_mult: 1, x_start: -50, x_mult: 2, photo: '600x400/1a202c/ffffff?text=N+Stand+View' },
                    's-stand': { name: 'S 스탠드', z: 75, y_base: 5, y_mult: 1, x_start: -50, x_mult: 2, photo: '600x400/1a202c/ffffff?text=S+Stand+View' },
                },
                events: [
                    { date: '2025-09-15', title: '국가대표 평가전: 대한민국 vs 브라질', type: '스포츠' },
                    { date: '2025-10-02', title: '글로벌 K-POP 페스티벌', type: '콘서트' }
                ]
            },
            'concertHall': {
                name: '콘서트 홀',
                stageCenter: new THREE.Vector3(0, 5, 0),
                model: [
                    { type: 'box', args: [40, 2, 20], position: [0, 1, 10], color: 0xbe185d },
                    { type: 'plane', args: [100, 100], position: [0, 25, -40], rotation: [0, 0, 0], color: 0x374151 },
                    { type: 'plane', args: [100, 50], position: [-50, 25, 10], rotation: [0, Math.PI / 2, 0], color: 0x374151 },
                    { type: 'plane', args: [100, 50], position: [50, 25, 10], rotation: [0, -Math.PI / 2, 0], color: 0x374151 },
                ],
                sections: {
                    'floor': { name: '플로어', z: 40, z_mult: 1.5, y_base: 2, y_mult: 0.1, x_mult: 1.5, photo: '600x400/1a202c/ffffff?text=Concert+Floor+View' },
                    'box-l': { name: '박스석 좌', x: -35, z: 50, z_mult: 1, y_base: 15, y_mult: 0.5, x_mult: 0.5, photo: '600x400/1a202c/ffffff?text=Box+Seat+View' },
                    'box-r': { name: '박스석 우', x: 35, z: 50, z_mult: 1, y_base: 15, y_mult: 0.5, x_mult: 0.5, photo: '600x400/1a202c/ffffff?text=Box+Seat+View' },
                },
                events: [
                    { date: '2025-11-20', title: '피아니스트 조성진 리사이틀', type: '클래식' },
                    { date: '2025-12-25', title: '크리스마스 재즈 콘서트', type: '콘서트' }
                ]
            },
            'theater': {
                name: '뮤지컬/극장',
                stageCenter: new THREE.Vector3(0, 8, 0),
                model: [
                    { type: 'box', args: [30, 2, 10], position: [0, 1, 10], color: 0x9f1239 },
                    { type: 'plane', args: [80, 80], position: [0, 20, -30], rotation: [0, 0, 0], color: 0x4b5563 },
                    { type: 'plane', args: [80, 40], position: [-40, 20, 10], rotation: [0, Math.PI / 2, 0], color: 0x4b5563 },
                    { type: 'plane', args: [80, 40], position: [40, 20, 10], rotation: [0, -Math.PI / 2, 0], color: 0x4b5563 },
                ],
                sections: {
                    'level1': { name: '1층', z: 40, z_mult: 1.2, y_base: 2, y_mult: 0.3, x_mult: 1.8, photo: '600x400/1a202c/ffffff?text=Theater+1F+View' },
                    'level2': { name: '2층', z: 50, z_mult: 1, y_base: 15, y_mult: 0.5, x_mult: 2.0, photo: '600x400/1a202c/ffffff?text=Theater+2F+View' },
                    'level3': { name: '3층', z: 60, z_mult: 0.8, y_base: 25, y_mult: 0.5, x_mult: 2.2, photo: '600x400/1a202c/ffffff?text=Theater+3F+View' },
                },
                events: [
                    { date: '2025-08-25', title: '뮤지컬 <오페라의 유령>', type: '뮤지컬' },
                    { date: '2025-09-10', title: '연극 <햄릿>', type: '연극' }
                ]
            },
            'baseball': {
                name: '야구 경기장',
                stageCenter: new THREE.Vector3(0, 5, -20),
                model: [
                    { type: 'plane', args: [200, 200], position: [0, 0.1, 0], rotation: [-Math.PI/2, 0, 0], color: 0x16a34a }, // Grass
                    { type: 'shape', shape: [[-45, -45], [0, -90], [45, -45], [0, 0]], position: [0, 0.2, 0], rotation: [-Math.PI/2, 0, 0], color: 0x92400e }, // Infield
                    { type: 'circle', args: [8, 32], position: [0, 0.3, -60.5], rotation: [-Math.PI/2, 0, 0], color: 0x92400e }, // Mound
                    { type: 'box', args: [4, 1, 4], position: [42.5, 0.3, -42.5], color: 0xffffff }, // 1B
                    { type: 'box', args: [4, 1, 4], position: [-42.5, 0.3, -42.5], color: 0xffffff }, // 3B
                    { type: 'box', args: [4, 1, 4], position: [0, 0.3, -85], rotation: [0, Math.PI/4, 0], color: 0xffffff }, // 2B
                    { type: 'cylinder', args: [100, 130, 20, 64, 1, true, Math.PI * 0.25, Math.PI * 0.5], position: [0, 10, 0], rotation: [0, Math.PI, 0], color: 0x374151},
                    { type: 'cylinder', args: [140, 160, 20, 64, 1, true, Math.PI * 0.25, Math.PI * 0.5], position: [0, 30, 0], rotation: [0, Math.PI, 0], color: 0x4b5563},
                ],
                 sections: {
                    'premium': { name: '중앙 프리미엄', r_base: 80, r_mult: 0.5, y_base: 5, y_mult: 0.5, angle_base: 180, angle_mult: 0.5, photo: '600x400/1a202c/ffffff?text=Premium+Seat+View' },
                    'infield-1b': { name: '1루 내야', r_base: 90, r_mult: 1, y_base: 8, y_mult: 0.5, angle_base: 225, angle_mult: 1.0, photo: '600x400/1a202c/ffffff?text=1B+Infield+View' },
                    'infield-3b': { name: '3루 내야', r_base: 90, r_mult: 1, y_base: 8, y_mult: 0.5, angle_base: 135, angle_mult: 1.0, photo: '600x400/1a202c/ffffff?text=3B+Infield+View' },
                    'outfield': { name: '외야', r_base: 150, r_mult: 1, y_base: 10, y_mult: 0.3, angle_base: 180, angle_mult: 1.5, photo: '600x400/1a202c/ffffff?text=Outfield+View' },
                },
                events: [
                    { date: '2025-08-22', title: '프로야구: LG 트윈스 vs 두산 베어스', type: '스포츠' },
                    { date: '2025-08-23', title: '프로야구: LG 트윈스 vs 두산 베어스', type: '스포츠' }
                ]
            },
            'basketball': {
                name: '농구 경기장',
                stageCenter: new THREE.Vector3(0, 5, 0),
                model: [
                    { type: 'box', args: [28, 0.5, 15], position: [0, 0.25, 0], color: 0xd97706 }, // Court floor
                    { type: 'plane', args: [40, 30], position: [-22, 15, 0], rotation: [0, Math.PI/2, -0.4], color: 0x374151 }, // West
                    { type: 'plane', args: [40, 30], position: [22, 15, 0], rotation: [0, -Math.PI/2, 0.4], color: 0x374151 }, // East
                    { type: 'plane', args: [60, 30], position: [0, 15, -20], rotation: [0.4, 0, 0], color: 0x4b5563 }, // North
                    { type: 'plane', args: [60, 30], position: [0, 15, 20], rotation: [-0.4, 0, 0], color: 0x4b5563 }, // South
                ],
                sections: {
                    'courtside': { name: '코트사이드', x: 0, z: 10, y_base: 1, y_mult: 0, x_mult: 1, photo: '600x400/1a202c/ffffff?text=Courtside+View' },
                    'lower-e': { name: '동측 하단', x: 22, y_base: 5, y_mult: 0.8, z_mult: 1, photo: '600x400/1a202c/ffffff?text=Lower+East+View' },
                    'lower-w': { name: '서측 하단', x: -22, y_base: 5, y_mult: 0.8, z_mult: 1, photo: '600x400/1a202c/ffffff?text=Lower+West+View' },
                    'upper-n': { name: '북측 상단', z: -20, y_base: 10, y_mult: 0.8, x_mult: 1.5, photo: '600x400/1a202c/ffffff?text=Upper+North+View' },
                    'upper-s': { name: '남측 상단', z: 20, y_base: 10, y_mult: 0.8, x_mult: 1.5, photo: '600x400/1a202c/ffffff?text=Upper+South+View' },
                },
                events: [
                    { date: '2025-11-05', title: '프로농구: SK 나이츠 vs KCC 이지스', type: '스포츠' }
                ]
            },
            'gymnasium': {
                name: '실내 체육관',
                stageCenter: new THREE.Vector3(0, 5, 0),
                model: [
                    { type: 'box', args: [20, 0.5, 30], position: [0, 0.25, 0], color: 0x065f46 }, // Court floor
                    { type: 'plane', args: [40, 30], position: [-25, 15, 0], rotation: [0, Math.PI/2, -0.6], color: 0x374151 }, // West
                    { type: 'plane', args: [40, 30], position: [25, 15, 0], rotation: [0, -Math.PI/2, 0.6], color: 0x374151 }, // East
                ],
                sections: {
                    'floor': { name: '플로어', x: 0, z: 20, y_base: 1, y_mult: 0, x_mult: 1, photo: '600x400/1a202c/ffffff?text=Gym+Floor+View' },
                    'stand-e': { name: '동측 스탠드', x: 25, y_base: 5, y_mult: 0.8, z_mult: 1.2, photo: '600x400/1a202c/ffffff?text=East+Stand+View' },
                    'stand-w': { name: '서측 스탠드', x: -25, y_base: 5, y_mult: 0.8, z_mult: 1.2, photo: '600x400/1a202c/ffffff?text=West+Stand+View' },
                },
                events: [
                    { date: '2025-10-15', title: '프로배구: 우리카드 vs 대한항공', type: '스포츠' }
                ]
            }
        };

        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x111827);
            scene.add(venueGroup);
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 50, 150);
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            canvasContainer.appendChild(renderer.domElement);
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.8);
            scene.add(ambientLight);
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.5);
            directionalLight.position.set(0, 100, 50);
            scene.add(directionalLight);
            const floor = new THREE.Mesh(new THREE.PlaneGeometry(500, 500), new THREE.MeshLambertMaterial({ color: 0x1f2937 }));
            floor.rotation.x = -Math.PI / 2;
            scene.add(floor);

            venueSearchInput.addEventListener('keyup', (e) => { if (e.key === 'Enter') handleSearch(); });
            mapBtn.addEventListener('click', openMap);
            sectionSelect.addEventListener('change', updateAndSelectSeat);
            rowInput.addEventListener('input', updateAndSelectSeat);
            seatInput.addEventListener('input', updateAndSelectSeat);
            window.addEventListener('resize', onWindowResize);
            canvasContainer.addEventListener('mousedown', onMouseDown);
            canvasContainer.addEventListener('mousemove', onMouseMove);
            canvasContainer.addEventListener('mouseup', onMouseUp);
            canvasContainer.addEventListener('mouseleave', onMouseUp);
            showPhotoBtn.addEventListener('click', showVRModal);
            closeModalBtn.addEventListener('click', hideVRModal);
            photoModal.addEventListener('click', (e) => { if(e.target === photoModal) hideVRModal(); });
            
            document.addEventListener('click', (e) => {
                const path = e.target.closest('.seating-map-svg path, .seating-map-svg polygon, .seating-map-svg rect');
                if (path && path.dataset.section) {
                    sectionSelect.value = path.dataset.section;
                    updateAndSelectSeat();
                }
            });

            handleSearch(); 
            animate();
        }
        
        function handleSearch() {
            const query = venueSearchInput.value.toLowerCase();
            if (query.includes('야구')) {
                currentVenueKey = 'baseball';
            } else if (query.includes('축구') || query.includes('경기장')) {
                currentVenueKey = 'stadium';
            } else if (query.includes('농구')) {
                currentVenueKey = 'basketball';
            } else if (query.includes('체육관')) {
                currentVenueKey = 'gymnasium';
            } else if (query.includes('뮤지컬') || query.includes('극장')) {
                currentVenueKey = 'theater';
            } else if (query.includes('콘서트') || query.includes('홀')) {
                currentVenueKey = 'concertHall';
            } else {
                currentVenueKey = 'stadium';
            }
            buildScene();
        }

        function openMap() {
            const query = venueSearchInput.value;
            if (query) {
                const url = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(query)}`;
                window.open(url, '_blank');
            }
        }

        function buildScene() {
            while(venueGroup.children.length > 0){ venueGroup.remove(venueGroup.children[0]); }
            const data = venueData[currentVenueKey];
            stageCenter = data.stageCenter;
            data.model.forEach(objInfo => {
                let geometry, material, mesh;
                material = new THREE.MeshLambertMaterial({ color: objInfo.color, side: THREE.DoubleSide });
                if (objInfo.type === 'box') geometry = new THREE.BoxGeometry(...objInfo.args);
                if (objInfo.type === 'cylinder') geometry = new THREE.CylinderGeometry(...objInfo.args);
                if (objInfo.type === 'plane') geometry = new THREE.PlaneGeometry(...objInfo.args);
                mesh = new THREE.Mesh(geometry, material);
                mesh.position.set(...objInfo.position);
                if(objInfo.rotation) mesh.rotation.set(...objInfo.rotation);
                venueGroup.add(mesh);
            });
            sectionSelect.innerHTML = '';
            for (const key in data.sections) {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = data.sections[key].name;
                sectionSelect.appendChild(option);
            }
            seatingMapOverviewContainer.innerHTML = seatingMaps[currentVenueKey];
            updateEventList();
            updateAndSelectSeat();
        }

        function updateEventList() {
            eventListContainer.innerHTML = '';
            const data = venueData[currentVenueKey];
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            if (data.events && data.events.length > 0) {
                const upcomingEvents = data.events.filter(event => new Date(event.date) >= today);
                const pastEvents = data.events.filter(event => new Date(event.date) < today);

                if (upcomingEvents.length > 0) {
                    eventListContainer.innerHTML += `<h3 class="text-md font-semibold text-gray-300 mb-2">예정된 행사</h3>`;
                    upcomingEvents.forEach(event => {
                        const eventDiv = document.createElement('div');
                        eventDiv.className = 'bg-gray-700/50 p-3 rounded-lg';
                        const typeColor = event.type === '스포츠' ? 'text-green-400' : 'text-pink-400';
                        eventDiv.innerHTML = `<p class="font-semibold text-white text-sm">${event.title}</p><div class="flex justify-between items-center mt-1"><span class="text-xs text-gray-400">${event.date}</span><span class="text-xs font-bold ${typeColor}">${event.type}</span></div>`;
                        eventListContainer.appendChild(eventDiv);
                    });
                }

                if (pastEvents.length > 0) {
                     eventListContainer.innerHTML += `<h3 class="text-md font-semibold text-gray-500 mt-4 mb-2">지난 행사</h3>`;
                     pastEvents.forEach(event => {
                        const eventDiv = document.createElement('div');
                        eventDiv.className = 'bg-gray-700/50 p-3 rounded-lg opacity-60';
                        const typeColor = event.type === '스포츠' ? 'text-green-400' : 'text-pink-400';
                        eventDiv.innerHTML = `<p class="font-semibold text-white text-sm">${event.title}</p><div class="flex justify-between items-center mt-1"><span class="text-xs text-gray-400">${event.date}</span><span class="text-xs font-bold ${typeColor}">${event.type}</span></div>`;
                        eventListContainer.appendChild(eventDiv);
                    });
                }

                if (upcomingEvents.length === 0 && pastEvents.length === 0) {
                    eventListContainer.innerHTML = `<p class="text-sm text-gray-400 text-center">예정된 행사가 없습니다.</p>`;
                }

            } else {
                eventListContainer.innerHTML = `<p class="text-sm text-gray-400 text-center">예정된 행사가 없습니다.</p>`;
            }
        }

        function updateAndSelectSeat() {
            const block = sectionSelect.value;
            const row = parseInt(rowInput.value);
            const seat = parseInt(seatInput.value);
            selectSeat(block, row, seat);
        }

        function selectSeat(block, row, seat) {
            const layout = venueData[currentVenueKey].sections;
            const rowInfo = layout[block];
            if (!rowInfo || row > 30 || seat > 50) { // Simplified validation
                seatInfo.textContent = `잘못된 좌석 정보입니다.`;
                return;
            }

            let x, y, z;
            if (rowInfo.r_base) {
                const angleDeg = rowInfo.angle_base - ((seat - 25.5) * rowInfo.angle_mult);
                const angleRad = (angleDeg * Math.PI) / 180;
                const radius = rowInfo.r_base + (row * rowInfo.r_mult);
                x = radius * Math.sin(angleRad);
                z = radius * Math.cos(angleRad);
            } else {
                x = rowInfo.x || 0;
                z = rowInfo.z || 0;
                if(rowInfo.x_mult) x += (seat - 25.5) * rowInfo.x_mult;
                if(rowInfo.z_mult) z += (seat - 25.5) * rowInfo.z_mult;
            }
            y = rowInfo.y_base + (row * rowInfo.y_mult);

            targetPosition.set(x, y, z + 1.5); // 눈높이 조정

            const tempMatrix = new THREE.Matrix4();
            tempMatrix.lookAt(targetPosition, stageCenter, camera.up);
            euler.setFromRotationMatrix(tempMatrix);
            camera.quaternion.setFromEuler(euler);

            seatInfo.textContent = `선택 좌석: ${rowInfo.name} ${row}열 ${seat}번`;
            sectionSelect.value = block;
            rowInput.value = row;
            seatInput.value = seat;

            updateOverviewMarker(block);
        }

        function on3DSeatClick(event) {
            // This function is kept for future implementation if needed
        }
        
        function updateOverviewMarker(block) {
            const overviewMap = seatingMapOverviewContainer.querySelector('.seating-map-svg');
            const marker = overviewMap.querySelector('#overview-marker');
            const sectionShape = overviewMap.querySelector(`[data-section="${block}"]`);
            
            overviewMap.querySelectorAll('[data-section]').forEach(p => p.classList.remove('selected'));
            if(sectionShape) {
                sectionShape.classList.add('selected');
                const bbox = sectionShape.getBBox();
                marker.setAttribute('cx', bbox.x + bbox.width / 2);
                marker.setAttribute('cy', bbox.y + bbox.height / 2);
            }
        }

        function showVRModal() {
            if (!seatInfo.textContent.includes('스탠드') && !seatInfo.textContent.includes('블록') && !seatInfo.textContent.includes('내야') && !seatInfo.textContent.includes('외야') && !seatInfo.textContent.includes('프리미엄') && !seatInfo.textContent.includes('하단') && !seatInfo.textContent.includes('상단') && !seatInfo.textContent.includes('코트사이드') && !seatInfo.textContent.includes('플로어')) {
                alert("좌석을 먼저 선택해주세요.");
                return;
            }
            photoDescription.textContent = `${seatInfo.textContent} 360° 뷰 (샘플 이미지)`;
            photoModal.classList.remove('hidden');
            initVR(`https://placehold.co/2048x1024/cccccc/000000?text=Sample+360+View`);
        }
        
        function hideVRModal() {
            photoModal.classList.add('hidden');
            if (vrAnimationId) cancelAnimationFrame(vrAnimationId);
            if (vrRenderer) {
                vrRenderer.dispose();
                vrCanvasContainer.innerHTML = '';
            }
        }

        function initVR(imageUrl) {
            vrScene = new THREE.Scene();
            vrCamera = new THREE.PerspectiveCamera(75, vrCanvasContainer.clientWidth / vrCanvasContainer.clientHeight, 1, 1100);
            vrRenderer = new THREE.WebGLRenderer({ antialias: true });
            vrRenderer.setSize(vrCanvasContainer.clientWidth, vrCanvasContainer.clientHeight);
            vrCanvasContainer.appendChild(vrRenderer.domElement);

            const geometry = new THREE.SphereGeometry(500, 60, 40);
            geometry.scale(-1, 1, 1);

            const texture = new THREE.TextureLoader().load(imageUrl);
            const material = new THREE.MeshBasicMaterial({ map: texture });
            const sphere = new THREE.Mesh(geometry, material);
            vrScene.add(sphere);

            let isVrDragging = false;
            let previousVrMousePosition = { x: 0, y: 0 };
            let vrEuler = new THREE.Euler(0, 0, 0, 'YXZ');

            function onVrPointerDown(e) {
                isVrDragging = true;
                const pointer = e.touches ? e.touches[0] : e;
                previousVrMousePosition = { x: pointer.clientX, y: pointer.clientY };
            }
            function onVrPointerUp() { isVrDragging = false; }
            function onVrPointerMove(e) {
                if (!isVrDragging) return;
                const pointer = e.touches ? e.touches[0] : e;
                const deltaX = pointer.clientX - previousVrMousePosition.x;
                const deltaY = pointer.clientY - previousVrMousePosition.y;

                vrEuler.y -= deltaX * 0.004;
                vrEuler.x -= deltaY * 0.004;
                vrEuler.x = Math.max(-Math.PI / 2, Math.min(Math.PI / 2, vrEuler.x));
                vrCamera.quaternion.setFromEuler(vrEuler);

                previousVrMousePosition = { x: pointer.clientX, y: pointer.clientY };
            }

            vrCanvasContainer.addEventListener('mousedown', onVrPointerDown);
            vrCanvasContainer.addEventListener('mousemove', onVrPointerMove);
            vrCanvasContainer.addEventListener('mouseup', onVrPointerUp);
            vrCanvasContainer.addEventListener('mouseleave', onVrPointerUp);
            vrCanvasContainer.addEventListener('touchstart', onVrPointerDown);
            vrCanvasContainer.addEventListener('touchmove', onVrPointerMove);
            vrCanvasContainer.addEventListener('touchend', onVrPointerUp);

            function animateVR() {
                vrAnimationId = requestAnimationFrame(animateVR);
                vrRenderer.render(vrScene, vrCamera);
            }
            animateVR();
        }

        function onMouseDown(e) { 
            isDragging = true; 
            canvasContainer.classList.add('grabbing'); 
            previousMousePosition.x = e.clientX; 
            previousMousePosition.y = e.clientY; 
        }
        function onMouseUp() { 
            isDragging = false; 
            canvasContainer.classList.remove('grabbing'); 
        }
        function onMouseMove(e) {
            if (!isDragging) return;
            const deltaX = e.clientX - previousMousePosition.x;
            const deltaY = e.clientY - previousMousePosition.y;
            
            euler.y -= deltaX * 0.002;
            euler.x -= deltaY * 0.002;
            euler.x = Math.max(-Math.PI / 2, Math.min(Math.PI / 2, euler.x));

            previousMousePosition.x = e.clientX;
            previousMousePosition.y = e.clientY;
        }

        function animate() {
            requestAnimationFrame(animate);
            if (camera.position.distanceTo(targetPosition) > 0.01) {
                camera.position.lerp(targetPosition, 0.1);
            }
            camera.quaternion.setFromEuler(euler);
            renderer.render(scene, camera);
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        init();
    </script>
</body>
</html>
